# 高中家校生活模拟器 - 功能需求文档

## ⚠️ 重要说明：UI与功能逻辑整合

**本功能逻辑全部通过"仿微信聊天窗口"触发和反馈**。

* **家长操作**（寄送/充值/建议/群聊发言）= 在聊天窗口里点按钮 → 生成一条家长气泡 + 系统灰条反馈
* **孩子行为**（短信/电话/延迟事件）= 系统在合适的时段生成孩子气泡/系统消息插入同一个窗口
* **不存在单独的"校园端 UI"**；所有交互都以同一个对话框为载体

### UI → 功能对应表

| UI 触发 | 功能文档对应 RuleID | UI 反馈样式 |
|---------|-------------------|------------|
| 点击"寄送物品"按钮 | `ACT.SEND_PARCEL.<ITEM>` | 系统灰条提示「物品已寄送」，T+N 后孩子白色气泡反馈 |
| 点击"充值校园卡" | `ACT.RECHARGE.CAMPUS` | 系统灰条提示「充值成功」，下个时段孩子白色气泡感谢 |
| 点击"建议"按钮 | `ACT.SUGGESTION.<TOPIC>` | 家长绿色气泡「要不要参加社团？」 → 下个时段孩子白色气泡采纳/拒绝 |
| 群聊发言 | `ACT.GROUP_POST.SOOTHE/COMPARE/ASK` | 群聊灰色气泡「你发送了安抚发言」+ 群氛围影响 |
| 点击伪输入框 | `parent_msg` 候选选择 | 家长绿色气泡发送消息 → 根据时段决定是否立即回复 |
| 来电弹窗 | `child_call` 事件 | 接听/忽略选项 → 孩子需求说明 + 3个应答选项 |

---

## 1. 领域模型

### 1.1 主体

* `Parent`（家长/玩家）
* `Child`（孩子）
* `Group`（家长群，包含老师与家长的系统发言）

### 1.2 关键状态（子系统）

* `stats`：`mood`(心情)｜`study`(学习力/效率)｜`energy`(精力/健康)｜`affinity`(亲密/好感)｜`trust`(信任)
* `balances`：`campus_card`(校园卡)｜`phone_card`(电话卡)｜`parent_fund`(家长可支配资金)
* `personality`（性格五轴，0~100：`studious`好学、`diligent`勤奋、`social`社交、`independence`独立、`justice`正义）
* `buffs`：`nagging_fatigue`(唠叨疲劳)｜`rebellion`(叛逆)｜`anxiety`(焦虑)｜`overspend`(消费过度)
* `timeline`：节点枚举 `OPENING`(开学)→`MIDTERM`→`CLUB`→`PARENT_MEETING`→`FINAL`→`SENIOR_PREP`→`GAOKAO`
* `quiet_window`（回复窗口）：`after_class`｜`after_school`｜`after_selfstudy`（仅在这些窗口合并发送孩子的集中回复）

---

## 2. 事件调度与消息生成

### 2.1 消息来源（与 UI 对齐，但这里仅定义"来源类型"）

* `group_notice`（老师/家长群系统消息）
* `child_msg`（孩子短信/电话转文本）
* `parent_action`（家长在聊天内点选的功能：寄送、充值、建议、群内发言）
* `system_feedback`（功能结果/阈值预警/达成回执）
* `delayed_effect`（延迟结算的后效，如"快递签收""被宿管抓到"）

### 2.2 调度规则

* **即时回执**：所有 `parent_action` 立刻生成一条 `system_feedback`（例如"充值成功/已创建邮寄单"）。
* **合并回复**：`child_msg` 的回应在最近的 `quiet_window` 统一投递（避免"秒回"）。
* **延迟事件**：物品寄送等含 `delivery_days`，按配置在 T+N 触发 `delayed_effect`。
* **节点评价**：进入 `timeline` 新节点时，插入阶段总结（成绩/心情曲线与关键事件列表）。

---

## 3. 可点击功能（动作定义）

> 每个功能给出：触发条件、规则 ID、冷却、参数、数值影响、可能的后效与阈值副作用。所有增减量用 **系数** 表示，真实数值从配置表读取。

### 3.1 群聊发言（家长在群上下文选择发言）

* **Trigger**：`parent_action.GROUP_POST`（在最近一条 `group_notice` 上下文）
* **Params**：`tone` ∈ {`soothe`安抚, `compare`对比/晒, `ask`提问}
* **Cooldown**：每 6 小时最多 1 次
* **Effect**：

  * `soothe`：`expectation`↓(群氛围)、`mood`↑ε
  * `compare`：`expectation`↑、`mood`↓ε；计入「对比压力计数」
  * `ask`：无直接数值，仅可能触发老师额外 `group_notice`
* **Threshold/Buff**：

  * 近 7 天 `compare_count ≥ COMPARE_LIMIT` → `buff.anxiety += 1`
* **RuleID**：`ACT.GROUP_POST.SOOTHE/COMPARE/ASK`

### 3.2 发送建议（是否报社团/补习/作息等）

* **Trigger**：`parent_action.SEND_SUGGESTION`
* **Params**：`topic`（枚举：`club`, `tutoring`, `schedule`, …）
* **Cooldown**：每日 ≤ `SUGGESTION_DAILY_LIMIT`
* **Effect**：

  * 立即回执（系统）：建议已记录
  * **接受判定**（在下一个 `quiet_window` 由孩子回条）：

    ```
    accept_prob = BASE(topic)
                 + W1*trust + W2*personality.independence*(-1) + W3*buff.nagging_fatigue*(-1)
                 + context_bonus(topic, timeline) + rand()
    ```

    * 接受：根据 `topic` 修改 `study/social/energy` 等长期系数，`trust`↑
    * 拒绝：`trust`↓ε、`affinity`↓ε，并可能触发"坚持己见"分支
* **Threshold/Buff**：

  * 近 7 天建议次数 ≥ `NAGGING_LIMIT` → `buff.nagging_fatigue = 1`（`mood`↓、`affinity`↓）
* **RuleID**：`ACT.SUGGESTION.<TOPIC>`

### 3.3 校园卡充值

* **Trigger**：`parent_action.RECHARGE_CAMPUS_CARD`
* **Precondition**：`parent_fund ≥ amount`
* **Params**：`amount`（20/50/100/自定义）
* **Cooldown**：无（但可配 `RECHARGE_MIN_INTERVAL`）
* **Effect**：

  * 即时：`balances.campus_card += amount`、`parent_fund -= amount`
  * 若 `balances.campus_card < LOW_CAMPUS_THRESHOLD` 时，系统会预先投递低额预警
  * 孩子在下个 `quiet_window` 以感谢或"已吃上饭"的自然语句回应（取决于 `affinity`）
* **Failure**：若 `parent_fund < amount` → 失败回执
* **RuleID**：`ACT.RECHARGE.CAMPUS`

### 3.4 电话卡充值

* **Trigger**：`parent_action.RECHARGE_PHONE_CARD`
* **Effect**：同上；当 `phone_card=0` 时，孩子只能发"余额不足系统提示"；充值后恢复正常互动频率（`child_msg.frequency` 有上限）
* **RuleID**：`ACT.RECHARGE.PHONE`

### 3.5 邮寄物品

* **Trigger**：`parent_action.SEND_PARCEL`
* **Params**：`item_id`（从物品库），`quantity`，`delivery_days`
* **Cooldown**：每日寄送总数 ≤ `DAILY_SHIPMENT_LIMIT`
* **Immediate Effect**：创建运单；`system_feedback` 告知预计到达日
* **On Delivery (T+N)**：

  * `mood += ITEM_MOOD(item_id)`，`energy += ITEM_ENERGY(item_id)` 等
  * **可能的后效**（概率型触发，自带条件）：

    * 例：`instant_noodles` 在 `timeline ∈ DORM_PERIOD` 且 `discipline_low` 时 → 触发"半夜吃泡面被抓" → `mood +`(短期) / `trust -` / `anxiety +`
* **RuleID**：`ACT.SEND_PARCEL.<ITEM_ID>`

### 3.6 孩子电话/短信（系统生成、家长可回拨/留言）

* **Trigger**：`child_msg.REQUEST`（如"饭卡没钱了/想买耳机/要不要社团"）
* **Parent Replies**（按钮型）：

  * `CALL_BACK`（回拨）：若 `phone_card>0` → 记录一次通话，影响 `affinity`、`trust`
  * `LEAVE_MSG`（留言）：排队至 `quiet_window` 被阅读，权重低于通话
* **RuleID**：`ACT.REPLY.CALL_BACK` / `ACT.REPLY.LEAVE_MSG`

---

## 4. 数值系统与阈值

### 4.1 数值范围

* 所有主属性 ∈ [-100, +100]，显示时归一到 0~100
* 增量均使用**系数**（`Δ = K * BASE`），`BASE` 与 `K` 来自规则表

### 4.2 全局阈值（示例，均配置化）

* `LOW_CAMPUS_THRESHOLD`（校园卡低额预警）
* `SUGGESTION_DAILY_LIMIT`、`NAGGING_LIMIT`
* `COMPARE_LIMIT`（近 7 天对比/晒次数上限）
* `DAILY_SHIPMENT_LIMIT`
* `QUIET_WINDOWS`（三个时间锚点的具体时段）
* `NODE_DAYS`（每个 `timeline` 节点的持续天数）

### 4.3 Buff 效果（启用即生效，直至被消解）

* `nagging_fatigue`：`mood -= A`、`affinity -= B`、`accept_prob -= C`
* `rebellion`：拒绝建议概率↑、对惩罚的负面反弹↑
* `anxiety`：`energy -= A`、`study` 成长上限↓
* `overspend`：`child_msg` 中"想买东西"请求频率↑，`study` 微降

> **消解条件**（配置化）：例如一周建议次数 ≤1；或连续 3 天未触发对比/晒等。

---

## 5. 时间线与节点事件

* `OPENING`：触发军训/适应期事件池
* `MIDTERM`：成绩波动敏感期（`group_notice` 频率↑）
* `CLUB`：若采纳 `club` 建议，`social` 与 `energy` 曲线改写
* `PARENT_MEETING`：阶段总结（老师评价根据综合状态生成）
* `FINAL`：成绩结算，触发奖励/惩罚机会
* `SENIOR_PREP`：压力事件权重↑，`anxiety` 更易触发
* `GAOKAO`：结局生成（见 §8）

> 每节点进入时投递一条阶段提示；节点结束时生成总结卡（只读，不是 UI 设计说明，这里仅定义"必须投递一条系统总结消息"）。

---

## 6. 概率/判定模型（可配置）

### 6.1 建议采纳概率

```
accept_prob = BASE(topic)
            + α1*trust
            + α2*(studious + diligent)/2
            + α3*(independence*(-1))
            + α4*(nagging_fatigue? -1 : 0)
            + α5*context(topic, timeline)
            + noise(μ=0, σ=sigma)
→ accept_if (rand() < clamp01(accept_prob))
```

### 6.2 后效触发概率（以物品为例）

```
post_event_prob(item, context) =
    P0(item) + β1*timeline_bonus + β2*justice(-) + β3*rebellion(+)
```

---

## 7. 日志与一致性

* **事件日志** `event_log`：

  * `event_id`｜`correlation_id`（把家长点击与多条后续消息串起来）｜`rule_id`｜`actor`｜`params`｜`delta_stats`｜`ts`
* **财务日志** `finance_log`：充值/消费流水
* **消息索引** `msg_index`：`message_id`｜`source_type`｜`ref_event_id`（支持"引用消息"跳转）
* **幂等**：同一 `correlation_id` 重放不得产生二次结算

---

## 8. 结局计算（GAOKAO 节点）

* **输入**：`study` 终值、`affinity`、`trust`、关键节点表现、家长投入累计、活跃 Buff
* **规则**（配置化打分）：

  * `study_score` 权重最高
  * `independence + trust` 共同影响"独立型"分支
  * `rebellion + anxiety` 高 → "叛逆/黑暗"分支倾向
* **输出**：结局类型枚举 + 结局描述文案模板 ID

---

## 9. 配置表引用说明

本功能需求文档中的所有参数、规则和数值均引用 `/config` 目录下的配置文件：

### 9.1 全局参数引用

* 校园卡相关阈值：引用 `config/global_params.csv` 中的 `campus_warn`、`campus_lux`、`campus_cutoff_hours`
* 建议功能限制：引用 `config/global_params.csv` 中的 `advice_daily_cap`、`advice_min_interval_min`
* 电话卡相关：引用 `config/global_params.csv` 中的 `tel_warn`、`tel_sms_cost`、`tel_call_min_cost`

### 9.2 规则配置引用

* 所有规则触发条件：引用 `config/rules_config.csv` 中的规则定义
* 规则ID映射：如 `ACT.RECHARGE.CAMPUS` 对应 `config/rules_config.csv` 中的 `R-CAMP-RECOVER`

### 9.3 性格相容度引用

* 建议接受概率计算：引用 `config/trait_affinity.csv` 中的性格权重
* 性格影响系数：如 `α2*(studious + diligent)/2` 中的权重来自 `config/trait_affinity.csv`

### 9.4 反馈模板引用

* 孩子回复生成：引用 `config/feedback_seed.csv` 中的模板库
* 状态×性格×物品组合：根据当前状态查询 `config/feedback_seed.csv` 生成相应反馈

---

## 10. 异常与边界

* `phone_card = 0` 时，任何 `CALL_BACK` 失败，记录失败回执 + 引导充值
* 同一自然日超过频率限制，直接回执"今日频次上限"
* 配置缺失或表达式错误：落错误日志并返回"系统繁忙"（不生成数值变化）

---

## 11. 验收要点（开发自测清单）

1. 家长所有点击均产生唯一 `correlation_id`，其后续系统/孩子回条均可追溯
2. `quiet_window` 生效：孩子不会"秒回"，统一在窗口投递
3. 建议频次超阈触发 `nagging_fatigue`，对后续建议采纳概率生效
4. 校园卡/电话卡余额正确增减，且低额预警提前出现
5. 物品寄送能在 T+N 触发签收及可能的后效事件
6. 节点切换按 `NODE_DAYS` 推进，并生成阶段总结消息
7. 结局分支与配置权重一致，可通过修改 CSV 变化结果
