# 高中家校生活模拟器 · 综合需求规格说明书（以 mock_ui_final_v9_副本.html 为准）

本文档整合并统一以下文档与原型，解决相互冲突处，作为后续实现的唯一依据：
- 原型：`mock_ui_final_v9_副本.html`（UI骨架与交互节奏以此为准）
- 参考与取材：`UI功能整合说明.md`、`UI设计需求文档.md`、`功能需求文档.md`、`用户故事地图.md`、`补充规则详细版.md`

本文分为：统一结论（解决冲突）、MVP规范、规则与数据、验收要点与路线图。

---

## 一、统一结论（冲突裁剪与定调）

- 导航与页面数量
  - 以原型为准：底部 3 个 Tab（消息、操作、状态）。
  - “测试模式”不作为产品内显页面，后续仅作为开发调试工具（可隐藏入口）。
- 单一交互界面 vs 操作页冲突
  - 统一口径：虽存在独立的“操作”与“状态”页，但“聊天窗口是唯一的事实流（Feed）”。
  - 任何操作（充值、寄送、建议、群发言）都必须向对应聊天线程写入一条系统/家长消息做留痕，确保信息在聊天内可追溯。
- 伪输入框/建议区触发方式
  - 以原型为准：点击聊天容器可切换建议区显隐；底部输入栏为装饰性输入，当前不接受键盘输入。
- 来电弹窗、按钮型消息（回拨/确认等）
  - 原型未覆盖，列入路线图，不纳入本期MVP验收。
- 群聊发言选项与冷却
  - 原型未提供专门发言面板；本期以“建议区/候选语”形式在群聊页提供 1~3 条候选，点击后插入群聊消息与系统反馈。冷却与氛围影响规则保留，但以简化实现。
- 状态查看形式
  - 以原型为准：独立“状态”页（非弹窗）。所有数值变化仍需在聊天中追加系统小条作为回执。
- 配置文件引用（/config/*.csv）
  - 现阶段项目中尚未存在此目录。本期MVP使用“内置默认值”。待引入配置后，再切换为外部化读取。
- 时间戳、引用样式、Toast
  - 原型未实现。时间戳与系统灰条在聊天中以简化文本样式呈现；引用与Toast列入路线图。

---

## 二、信息架构与导航（以原型为准）

- 底部 Tab（3）
  1) 消息：默认进入“消息列表（#list）”，可跳转“家长群（#group）/孩子私聊（#child）”。
  2) 操作（#operate）：资金概况、寄送物品、充值快捷卡片。
  3) 状态（#status）：孩子头像、基础属性（心情/学习力/精力/亲密度）、性格维度、进度条。

- 路由锚点
  - `#list` → 消息列表；`#group` → 家长群；`#child` → 孩子私聊；`#operate` → 操作；`#status` → 状态。

- 单一事实流原则
  - 不论在“消息、操作、状态”哪个页面产生动作，均需要将“结果回执/孩子反馈”注入对应聊天线程（群聊或孩子私聊）。聊天是首选可观察介质。

---

## 三、UI与交互规范（MVP）

### 3.1 聊天窗口（群聊/孩子私聊）
- 气泡类型（沿用原型配色）
  - 家长（我）：绿色，右对齐。
  - 孩子：白色，左对齐。
  - 群聊其他家长/老师：灰/白系，左对齐，显示“群/家/老师”头像字样。
  - 系统回执：简化为灰色文本小条（插入聊天流）。
- 建议区显隐
  - 点击聊天区域空白处切换 `suggestions` 显示/隐藏。
  - 建议区展示 1~3 条与当前页面上下文相关的选项（群聊与私聊可不同）。
- 输入栏
  - 当前为装饰性输入，不接收真实键入；保留“发送”按钮但仅演示（或直接隐藏）。

### 3.2 操作页（快捷操作入口）
- 资金概况：显示可支配、校园卡、电话卡余额（静态或实时）。
- 寄送物品：展示若干示例 Chip（泡面×5/衣物/书籍等）。
- 充值：校园卡与电话卡展示预设金额按钮（+20/+50/+100…）。
- 统一行为：点击任一“操作”会产生两类结果
  1) 立刻在孩子私聊插入一条系统回执消息（例如“已为校园卡充值 50 元”）。
  2) 必要时在下一个“回复窗口”投递孩子反馈（例如“谢谢，今天吃上饭啦”）。

### 3.3 状态页
- 信息与布局沿用原型：头像、基础四维、三列性格表格、进度条与当前时间段。
- 本期只读；数值变化以聊天系统条进行说明（不强制实时刷新）。

---

## 四、领域模型（MVP裁剪版）

- 主体
  - Parent（家长/玩家）、Child（孩子）、Group（家长群）。
- 状态
  - 基础四维：`mood`（心情）`study`（学习力）`energy`（精力）`affinity`（亲密度）∈ [0,100]。
  - 资金：`parent_fund`（家长可支配）、`campus_card`（校园卡）、`phone_card`（电话卡）。
  - 性格：展示 3~6 个维度（如：好学/勤奋/社交/独立/正义等），0~100。
  - 时间段（回复窗口）：`after_class`｜`after_school`｜`after_selfstudy`（用于合并回复）。

---

## 五、事件与消息（MVP）

- 来源类型
  - `group_notice`（群系统/老师消息）、`child_msg`（孩子消息）、`parent_action`（家长操作）、`system_feedback`（系统回执）、`delayed_effect`（延迟后效）。
- 调度规则
  - 即时回执：所有 `parent_action` 先注入一条 `system_feedback` 到相应聊天（多为孩子私聊）。
  - 合并回复：孩子对建议/充值/寄送的反馈，优先在下一个“回复窗口”统一投递；若未实现时间轴，可用固定延时（如 10～30 秒）模拟。
  - 延迟事件：寄送物品可配置 T+N 天投递“签收/后效”，MVP可用短延时模拟。

---

## 六、交互流程（可验收）

### 6.1 群聊发言
- 触发：在群聊页点击建议区条目（如“理解并支持孩子节奏/对比一下家长会时间/我们报了冲刺班”）。
- 结果：
  - 立即在群聊插入家长灰色气泡（或按原型风格），并插入系统小条记录影响（例如“群氛围：期望-1，孩子心情+ε”）。
  - 冷却（简化为：每 6 小时最多 1 次）；超频次提示系统小条“今日已达上限”。

### 6.2 对孩子的建议（孩子私聊页）
- 触发：点击建议区条目（如“晚上记得早点睡/加油，继续保持”）。
- 结果：
  - 立即注入家长绿色气泡与系统回执“建议已记录”。
  - 在下一回复窗口由孩子以白色气泡反馈“采纳/婉拒”，并对四维产生微小改动。

### 6.3 校园卡充值（操作页）
- 触发：点击 +20/+50/+100。
- 条件：`parent_fund ≥ amount`；否则插入系统小条“可支配资金不足”。
- 结果：
  - 余额变更：`campus_card += amount`，`parent_fund -= amount`（MVP内存态）。
  - 立即在孩子私聊插入系统回执：“已为校园卡充值 X 元”。
  - 下一回复窗口孩子反馈（感谢/自然用语）。

### 6.4 电话卡充值（操作页）
- 同校园卡充值；若 `phone_card ≤ 0`，充值后插入一次性系统条“通讯恢复可联系”。

### 6.5 寄送物品（操作页）
- 触发：点击 Chip（泡面×5/衣物/书籍）。
- 结果：
  - 立即系统回执：“已寄送【物品】，预计 T+N 天到达”。
  - T+N（MVP用短延时）后孩子反馈（感谢/效果），并可能有小概率后效（例如泡面被宿管抓到：心情短期+、信任-）。

---

## 七、规则与数值（MVP简化）

- 建议采纳判定（简化版，0~100）
  - `score = 0.4*trust + 0.3*align + 0.2*trait_aff + 0.1*mood_boost - nag_penalty - rebellion`
  - 采纳阈值：`score ≥ 60` 视为采纳。
  - 参数解释：
    - `trust`（基于亲密度/历史效果，0~100）
    - `align`（与情境一致性：0/50/100）
    - `trait_aff`（性格相容度，-30..+30）
    - `mood_boost`（心情/压力对口建议加减，-10..+10）
    - `nag_penalty`（同一日建议过多的惩罚：0/15/30）
    - `rebellion`（叛逆倾向，0..30）
- 频率限制（默认值，内置）
  - 每日建议上限 3 次；两次间隔≥60 分钟；10 分钟内≥2 次触发“唠叨层”（惩罚生效）。
- 经济/通讯阈值（默认值）
  - 校园卡告急 `< 30`；电话卡告警 `≤ 3`；`≤0` 通讯受限（仅系统条），充值后恢复。
- 数值变更幅度
  - MVP阶段采用小幅度离散调整（±1～±5），避免复杂平衡。

---

## 八、数据与一致性（MVP实现建议）

- 事件日志（内存）
  - `event_id`、`type`、`payload`、`ts`；`correlation_id` 将家长点击与孩子反馈串联。
- 幂等
  - 同一 `correlation_id` 不重复生效（MVP可通过去重表实现）。
- 配置
  - 本期不引入 `/config` 目录，使用内置默认值；后续迁移时将默认值落盘到 CSV。

---

## 九、异常与边界

- 可支配资金不足 → 充值失败系统条。
- 电话卡欠费 → 孩子侧消息频率降为系统欠费提示；充值后恢复。
- 超频率/冷却未到 → 系统条提示“今日频次上限/请稍后再试”。
- 未实现时间轴时的回复窗口 → 以固定延时模拟；切换到时间轴后生效真实窗口合并。

---

## 十、验收要点（MVP）

1) 导航与页面按原型可切换（消息列表→群聊/私聊→操作→状态）。
2) 在操作页点击任意操作，孩子私聊内必须出现系统回执消息；余额在内存中变更，状态页可查看到一致的数值（允许刷新/重进刷新）。
3) 在群聊/私聊点击建议区选项，插入家长气泡；下一回复窗口（或延时）投递孩子反馈。
4) 欠费/低额时触发对应系统条；充值后触发“恢复/感谢”反馈。
5) 所有动作均生成 `correlation_id` 并能追溯前后两条消息的关联（MVP可在开发者日志中验证）。

---

## 十一、路线图（后续版本）

- 来电弹窗与按钮型消息：接听/回拨/留言。
- 专门的群发言面板和冷却提示 UI；群氛围可视化。
- 时间戳、引用样式、消息跳转。
- Toast/加载/错误重试的统一体验。
- /config 目录的 CSV 外部化参数与模板（全局参数/规则/性格相容度/反馈模板）。
- 更完整的时间线与节点事件（开学/期中/社团/家长会/期末/备考/高考）。
- Buff/Debuff 的显式可视化与消解提示。
- 结局分支与结算卡片。

---

## 附录：默认参数（本期内置，后续迁移至 /config）

- 建议：`advice_daily_cap=3`、`advice_min_interval_min=60`、`nag_stack_window_min=10`
- 叛逆/信任基线：`rebellion_base=20`、`trust_base=50`
- 校园卡：`campus_warn=30`
- 电话卡：`tel_warn=3`、`tel_sms_cost=0.05`、`tel_call_min_cost=0.2`

以本文件为唯一依据实施MVP；其余文档作为素材与扩展参考，不再单独作为验收标准。



接入 AI（开发说明）
请在项目根目录创建 `config.local.js`（不提交到仓库），内容包含：
```
window.AI_CONFIG = {
  baseUrl: 'https://www.dmxapi.cn',
  apiKey: 'YOUR_TOKEN',
  model: 'gpt-4o-mini'
};
```
如未配置，系统将自动使用本地规则生成候选项作为降级方案。