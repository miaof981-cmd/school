# 高中家校生活模拟器 - 补充规则详细版

## 记号说明

变量用snake_case；数值默认可配置（写在"全局参数"里）。
所有生成与剧情严格限制在"校园内"主题域，不得出现校外地点/品牌/社会新闻等（见 §8 生成守护）。

---

## 0. 全局参数（默认值，可配）

> 所有参数均引用 `config/global_params.csv` 文件

* `advice_daily_cap=3`（每日建议上限）
* `advice_min_interval_min=60`（两次建议最小间隔）
* `nag_stack_window_min=10`（10分钟内多次建议触发"唠叨层"）
* `rebellion_base=20`（基础叛逆倾向，0–100）
* `trust_base=50`（基础信任，0–100）
* `campus_warn=30`（校园卡告急阈值，元）
* `campus_lux=300`（校园卡奢靡阈值，元）
* `campus_cutoff_hours=24`（≤0 持续时长触发"吃不上饭"）
* `tel_warn=3`（电话卡告警阈值，元）
* `tel_sms_cost=0.05`、`tel_call_min_cost=0.2`（短信/每分钟通话消耗）
* `content_whitelist_tags=[学习, 校园活动, 作息, 饮食, 亲子沟通, 心情, 物品寄送, 费用/充值]`

---

## 1. 「建议按钮」= 家长强引导系统（会影响发展轨迹）

### 1.1 建议的语义
* 这是父母对孩子的强引导，会对孩子的发展倾向/属性产生影响。
* 不是聊天补白；每次建议都会记录并影响"服从/叛逆/信任"等。

### 1.2 建议分类与作用面
* `advice_type ∈ {学业, 作息, 饮食, 社交, 自理, 节制消费}`
* 每类建议命中后，给相应维度加"目标倾向"（非立刻生效的属性点，而是后续行为的偏置）。
* 例：学业 → 学习偏置+；节制消费 → 消费冲动-、节俭+。

### 1.3 次数与冷却（防"唠叨"）
* 每日最多 `advice_daily_cap` 次；两次间隔 ≥ `advice_min_interval_min` 分钟。
* 若`nag_stack_window_min`内累计 ≥2 次建议 → 施加唠叨层（Nag L1），持续2小时：服从率-15%，叛逆+5；≥3次→ Nag L2：服从率-30%，叛逆+10。层数随时间衰减。

### 1.4 接受/拒绝判定（可直接落代码）

计算"服从评分 S（0–100）"，S≥60 则接受，否则拒绝/打折执行。

```
S = 0.4*trust      // 信任
  + 0.3*align      // 与当前状态/目标的一致性（0/50/100）
  + 0.2*trait_aff  // 性格相容度（-30..+30）
  + 0.1*mood_boost // 心情/压力加权（-10..+10）
  -  (nag_penalty) // 唠叨惩罚（0/15/30）
  -  (rebellion)   // 叛逆倾向（0..30）
```

* `trust`：基于亲密度/历史建议效果动态调整（0–100）。
* `align`：与孩子当前状态一致则 100；相反则 0；中性 50。
* `trait_aff`：见 §4 性格映射表，引用 `config/trait_affinity.csv`。
* `mood_boost`：低落/疲惫时对"休息类"建议+，对"学习类"建议-。
* `rebellion`：基础叛逆 + 近期被否定/被高压指导次数。
* 拒绝反馈：进入"缓和回应"，信任-2~5；若建议内容合理且语气温柔，减半惩罚。

### 1.5 建议的长期效果
* 接受 → 对应维度的行为偏置+（例如接下来一周更愿意执行相关行为），并有小概率形成"习惯种子"（7天内执行≥3次则固化为稳定习惯，+持久加成）。
* 过度建议 → 容易触发负面 BUFF（叛逆↑、回避沟通↑、亲密度↓）。

生成限制：建议文本只能来自校园域白名单（§8），AI仅做口吻衔接；不得引入校外行为（如"去商场""买外卖平台X"）。

---

## 2. 安静/不安静判定与切换（含自动清定时）

### 2.1 判定
* 安静：{上课, 晚自习, 就寝} + 手动"安静模式"。
* 非安静：{午休, 放学, 周末活动, 其它}。

### 2.2 切换规则
* 切换状态时，系统先执行 `clearAllTimers()`（清旧定时），再注册新状态的定时任务（如"晚自习结束提醒"）。
* 安静时：隐藏"立即回拨"，仅允许"留言/忽略"；孩子自动触发「简短且礼貌型」回复模板。
* 非安静：开放"立即回拨/预约回拨/短信"。

---

## 3. 孩子需求触发（状态组合→需求类型）

### 3.1 基础状态层
* 时间层：上课/午休/晚自习/放学/就寝/周末
* 血糖/饥饿：饱/稍饿/饥饿/断餐
* 学习压力：低/中/高/爆表
* 心情：平稳/紧张/低落/兴奋
* 健康：正常/感冒/疲惫
* 通讯：正常/告警/欠费
* 经济：奢靡/普通/告急/断供（见 §5）

### 3.2 组合触发表（示例，实际可扩）

| 组合条件 | 触发需求 | 频率/冷却 | 话术走向 |
|---------|---------|----------|---------|
| 晚自习 + 饥饿≥"饥饿" | 食品类帮助/建议早点补能量 | 每晚最多1次 | 结合性格生成（§4） |
| 午休 + 学习压力=高 | 学习节奏建议（小目标/分块） | 每日1次 | 温柔/鼓励优先 |
| 放学 + 心情=低落 | 情绪支持/倾诉 | 每日1次 | 避免说教 |
| 就寝 + 健康=疲惫 | 早点休息/明日计划 | 每晚1次 | 简短温柔 |
| 欠费 + 正在对话 | 欠费提示/请充值 | 每4小时一次 | 系统短条 |
| 告急(经济) + 饥饿≥饥饿 | 生活费补给请求 | 每日1次 | 体面表达，避免乞求语 |

---

## 4. 性格/品质体系（用于"相容度trait_aff"和话术风格）

每个孩子有 3–5 个主品质（0–100），用于建议服从、话术风格与事件偏好。

> 性格相容度数据引用 `config/trait_affinity.csv` 文件

| 品质 | 描述 | 对建议相容度举例 |
|------|------|-----------------|
| 勤劳/懂事 | 主动负责，体贴父母 | 学业/作息/节制消费 +10～+20；被唠叨影响减半 |
| 自律 | 遵守计划与规则 | 作息/学业 +15；"自由玩乐"类建议 -10 |
| 节俭 | 倾向合理花费 | 节制消费 +15；"请你多买点零食" -10 |
| 敏感/易受挫 | 情绪波动大 | 高压学业建议 -15；安慰/分解目标 +10 |
| 乐观/阳光 | 积极向上 | 鼓励类建议 +10；批评式建议 -10 |
| 害羞/安静 | 少话但柔和 | 外向社交类 -10；柔和私聊类 +10 |
| 调皮/幽默 | 爱玩有梗 | 轻松建议 +10；严肃长篇建议 -15 |
| 好胜 | 竞争驱动 | 目标挑战类 +10；"先休息"在高压期 -10 |
| 叛逆 | 抗拒控制 | 一切"命令口吻" -15～-30；选择题式建议惩罚减半 |
| 同理心 | 会顾及他人 | 分享/社团协作 +10 |

这些品质既影响trait_aff，也决定反馈文本的风格（同一事实，不同语气）。

---

## 5. 校园卡（生活费）判定 → 奢靡/普通/吃不上饭

### 5.1 判定与转移
* 奢靡：`campus_balance ≥ campus_lux` → 标记economy=奢靡（当周）。
* 普通：`campus_balance ∈ [campus_warn, campus_lux)`。
* 告急：`campus_balance < campus_warn`（每日22:00提醒一次）。
* 吃不上饭：`campus_balance ≤ 0` 且持续 ≥ `campus_cutoff_hours` → 触发一次性"断餐"剧情，体力下降、心情下降。

### 5.2 奢靡的行为后果（校园域内表达）
* 消费冲动上升：小卖部/奶茶/零食购买频次↑；"请客"概率↑。
* 高价电子/炫耀倾向：在校内通过同学间"换/借/二手转让"方式获得高价电子（不出现校外平台/品牌）；"展示/比较"事件↑。
* 价值观偏移：节俭品质被压制（临时-10），虚荣/面子临时+10（如果启用）。
* 触发频次：每周最多2次奢靡事件，避免泛滥。

### 5.3 贫困/告急的心理后果
* 对比心理：看到同学消费时心情-1（每日最多一次），学习注意力-。
* 主动节省：若节俭≥60，则自发减少无关消费，正向反馈"我会省着用"。
* 断餐时：进入"吃不上饭"剧情：学习效率-、体力-、对"饮食建议"的align=100。

### 5.4 恢复与记账
* 充值后 >0 → 立刻移除"断餐"；当天不再触发"告急"提醒。
* 所有事件入账到经济日志（时间、金额、状态切换、触发事件ID）。

---

## 6. 电话卡（通讯）判定与消耗/限流

### 6.1 判定
* `tel_balance ≤ tel_warn` → 告警（孩子发预警，12h冷却）。
* `tel_balance ≤ 0` → 欠费：禁止孩子发短信/打电话；对话插入"欠费暂无法回复"。

### 6.2 消耗模型（限制家长无意义刷对话）
* 孩子侧：发短信 -`tel_sms_cost`；通话每分钟 -`tel_call_min_cost`。
* 家长侧限流：同类消息（相同主题tag）需冷却≥`parent_same_topic_cooldown_min`（建议 30–60 分），否则提示"先等孩子回复/执行"。
* 策略：家长一侧不扣费，但过度发送会降低trust与"回复优先级"，并可能触发"回避沟通"短期状态。

### 6.3 恢复
* 充值 >0 → "恢复可联系"系统条（一次性），并重置本会话"欠费标记"。

---

## 7. 物品寄送（强化：规则与反馈生成）

### 7.1 物品库（最小字段）

```
{id, name, category∈[食品, 学习, 衣物, 卫生, 运动], sendable, effects{study,mood,health,discipline,thrift}, feedback_tags, notes}
```

### 7.2 校园域限制
* 不得出现校外品牌/平台；电子类物品以"学习相关配件/校内可借用设备"为表述。
* 违禁：刀具、烟酒、昂贵数码新品（若需要，以"来源不明电子"抽象并引导"规劝/上交"剧情）。

### 7.3 反馈生成（状态×性格×物品）
* 读取当前状态（如"晚自习"）→ 结合性格（§4）→ 选择反馈模板；AI仅润色。
* 例：食品×晚自习×勤劳：「收到了，现在在晚自习，等下课我和同学分着吃～你也要按时休息呀。」

> 反馈模板引用 `config/feedback_seed.csv` 文件

---

## 8. 生成守护（严格校园域）

* 白名单主题：学习/作业/考试/课堂/社团/寝室/食堂/小卖部/操场/校园通知/家校沟通/作息/饮食/费用与充值。
* 黑名单：校外逛街/品牌网购/社会新闻/兼职/政治/成人话题/外卖平台/具体商圈。
* 守护流程：候选/话术在落地前做"主题校验"：若topic ∉ 白名单 → 直接丢弃并重试，不向用户可见。
* 口吻：朴素、校园友好；避免地域刻板/敏感措辞。

---

## 9. 冲突优先级与兜底

* 优先级：欠费/断餐 > 安静 > 其它提醒。
* 同类提醒冷却：24h（经济）/12h（通讯）/1h（学习建议/休息建议）。
* 任何状态切换先执行 `clearAllTimers()`。
* 兜底：若AI超时/失败 → 使用本地模板；禁止输出空白/跑题文案。

---

## 10. 数据与可观测性（便于验收）

* 事件表：`event_id, type, payload, child_state_before/after, time`
* 规则命中日志：记录命中规则ID（如 R-CAMP-CUTOFF）与冷却。
* 建议结果：`advice_type, S评分, accept/reject, deltas, nag_level`
* 经济/通讯流水：充值/消耗/状态转移全量留痕。

---

## 11. 配置表引用说明

本补充规则文档中的所有参数、阈值和模板均引用 `/config` 目录下的配置文件：

### 11.1 全局参数引用
* 所有阈值参数：引用 `config/global_params.csv` 中的对应字段
* 冷却时间：引用 `config/global_params.csv` 中的时间相关参数
* 消耗系数：引用 `config/global_params.csv` 中的费用相关参数

### 11.2 规则配置引用
* 规则触发条件：引用 `config/rules_config.csv` 中的规则定义
* 规则动作：引用 `config/rules_config.csv` 中的动作描述
* 规则冷却：引用 `config/rules_config.csv` 中的冷却时间

### 11.3 性格相容度引用
* 性格权重计算：引用 `config/trait_affinity.csv` 中的权重数据
* 建议类型匹配：根据 `config/trait_affinity.csv` 计算相容度

### 11.4 反馈模板引用
* 孩子回复生成：引用 `config/feedback_seed.csv` 中的模板库
* 状态组合查询：根据当前状态查询 `config/feedback_seed.csv` 生成相应反馈

---

## 附：性格→相容度映射（trait_aff 快速表）

> 此表数据来源于 `config/trait_affinity.csv` 文件

| 建议类型 \ 品质 | 勤劳 | 自律 | 节俭 | 敏感 | 乐观 | 害羞 | 调皮 | 好胜 | 叛逆 |
|----------------|------|------|------|------|------|------|------|------|------|
| 学业 | +15 | +15 | 0 | -10 | +5 | 0 | -5 | +10 | -15 |
| 作息 | +10 | +15 | 0 | +5 | +5 | +5 | -5 | 0 | -10 |
| 饮食 | +5 | 0 | 0 | +5 | +5 | +5 | 0 | 0 | -5 |
| 社交 | 0 | -5 | 0 | -5 | +10 | -10 | +10 | +5 | 0 |
| 自理 | +10 | +10 | +5 | 0 | +5 | +5 | 0 | 0 | -5 |
| 节制消费 | +10 | +10 | +15 | 0 | 0 | 0 | -10 | 0 | -15 |

数值为建议加分（-30..+30），供 §1.4 公式使用。

---

## 附：奢靡/告急典型事件（校园表达）

* 奢靡：
  * 小卖部"大额零食拼单/请客"（展示/比较情境）
  * 与同学"借/换/二手收"高价电子（隐含炫耀动机）
* 告急：
  * 食堂余额不足导致"挑最便宜套餐/借同学饭卡"，心情-1
* 断餐：
  * 当天学习效率-10%、体力-15%，对"饮食类建议"align=100，优先接受
